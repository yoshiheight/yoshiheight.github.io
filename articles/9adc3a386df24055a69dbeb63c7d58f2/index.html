<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    
            <meta name="robots" content="noindex" />
        
    
            <meta name="robots" content="nofollow" />
        
    <meta name="description" content="C#とTypeScriptに関することをメインに書いています。" />

    <title>
        
                    DirectX9について書いたメモ | Programmer&#39;s Note
                
    </title>

    
            <link rel="stylesheet" href="/sitegen-2.1.0/css/sitegen.css" />
        
            <link rel="stylesheet" href="/sitegen-2.1.0/css/sitegen-article.css" />
        

    <script type="module" src="/sitegen-2.1.0/js/initialize.js"></script>

    
    <link rel="icon" type="image/png" href="/images/favicon-32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/images/favicon-48.png" sizes="48x48" />
    <link rel="icon" type="image/png" href="/images/favicon-64.png" sizes="64x64" />
    <link rel="icon" type="image/png" href="/images/favicon-128.png" sizes="128x128" />
    <link rel="icon" type="image/png" href="/images/favicon-256.png" sizes="256x256" />
    <link rel="apple-touch-icon" href="/images/favicon-256.png" sizes="256x256" />
    <link rel="stylesheet" href="/css/custom-1.0.css" />
</head>
<body>
    <!-- サイトヘッダー -->
    <header id="sdi-header">
        <div id="sdi-header-inner">
            <div id="sdi-site-name"><a href="/">Programmer&#39;s Note</a></div>
            <div id="sdi-menu">
                <div class="sdc-menu-section">
                    
                                            <div>
                                                <a href="/categories/demo/">Demo</a>
                                            </div>
                                        
                                            <div>
                                                <a href="/categories/tech/">Tech</a>
                                            </div>
                                        
                                            <div>
                                                <a href="/categories/scrap/">Scrap</a>
                                            </div>
                                        
                </div>
                <div class="sdc-menu-section">
                    <div>
                        <a href="/tags/">Tags</a>
                    </div>
                    <div>
                        <a href="/search/">Search</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <div id="sdi-container">
        <div id="sdi-container-inner">
            <main>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.6.0/build/styles/base16/nova.min.css" />
<script type="module">
    import hljs from "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.6.0/build/es/highlight.min.js";
    hljs.highlightAll();
</script>
<script type="module">
    import mermaid from "https://unpkg.com/mermaid@9.1.3/dist/mermaid.esm.min.mjs";
    mermaid.initialize({ startOnLoad: true, theme: "base" });
</script>

<article id="sdi-entry-article">
    <!-- 記事ヘッダー -->
    <header>
        <!-- 記事タイトル -->
        <h1>DirectX9について書いたメモ</h1>

        <div id="sdi-article-header-annotation">
            <!-- タグ -->
            <div class="sdc-tags">
                <div class="sdc-tag sdc-primary-tag sdc-primary-tag2">
                    <a href="/categories/scrap/">Scrap</a>
                </div>
                
                                    <div class="sdc-tag">
                                        <a href="/tags/3d/">3D</a>
                                    </div>
                                
                                    <div class="sdc-tag">
                                        <a href="/tags/directx/">DirectX</a>
                                    </div>
                                
                                    <div class="sdc-tag">
                                        <a href="/tags/general-dev/">開発全般</a>
                                    </div>
                                
            </div>

            <!-- 日付 -->
            <time datetime="2018-11-30">2018-11-30</time>
        </div>
    </header>

    <!-- 記事内容 -->
    <div id="sdi-article-body">
<h3>はじめに</h3>
<p>昔書いたDirectX9のメモが出てきたので、とりあえずアップしました。</p>
<h3>メモ</h3>
<ul>
<li>メッセージループは一般的には60FPSで描画する</li>
<li>メッセージループ中では適度なスリープを入れる。ウィンドウアクティブ状態によりスリープ量を可変にするとより最適。(アクティブ時:スリープなし、非アクティブ時:スリープ多め、等)</li>
<li>ベンチマーク的な事をしたい場合はFPS固定にしないで、とにかくぶん回す(FPSを測定したい場合など。その場合でもスクリプト更新処理は60FPSにしておく事)</li>
<li>プレゼンテーションパラメータのVSync同期はオフにしておく(VSync同期がオンの場合、描画結果の転送時(m_pD3DDevice-&gt;Present())に同期が行われる)</li>
<li>時間測定はウィンドウズマルチメディアタイマ(timeGetTime)を使用し精度を高めておく</li>
<li>基本的にゲーム内での絶対的な時間はフレームである</li>
<li>FPSが異なる環境で同じ速度にする場合や処理落ちしても通常と同じ分だけ移動させる場合、1フレームでの経過時間に速度をかける方法がある</li>
<li>ビューのOnPaintでもレンダリングしておくと描画もれを防げる</li>
<li>座標はスクリーン座標とワールド座標がある</li>
<li>デバイス消失(ロスト)を考慮する必要がある(ユーザーが解像度を変えたりとか)。デバイス再作成やテクスチャー作り変えをしないとだめ</li>
<li>GetDeviceCaps → これにより事前にデバイスの詳細情報を取得して適切な量のVRam確保を行ったりする</li>
<li>VertexBuffer → VRamに確保した頂点バッファ。Lockでシステムメモリにコピー、UnLockで逆にVRamにコピーされる。</li>
<li>Z順比較は無効にして、自分で描画する順番でZ順になるようにする事もある。(２Ｄだけ?)</li>
<li>Zソート法では物体が交差する場合、うまく描画できないので、Zバッファ法を使う。半透明のものはZソート法を使って後から描画。またZバッファ法では出来るだけ手前の物体から描画すると後ろの物体を描画するときに余計な書き込みが起こるのを防げるのでパフォーマンスが上がる。</li>
<li>行列で合成の繰り返しは誤差を生む(30度の行列と60度の行列の合成とか)。その場合は一度リセットし、新たに90度の回転行列を生成してそれを適用するべし。</li>
<li>回転は X軸、Y軸、Z軸 でどの順番で回転させるかで意味が違ってくる。(例: X軸回転後 → Y軸回転 と Y軸回転後 → X軸回転 では意味が違う)</li>
<li>フォントによる文字列描画はDrawPrimitiveに比べると格段に遅い。(スプライトを使っても遅かった)</li>
<li>Xファイルのデータはマテリアル単位になっているので、その単位で描画する(DrawSubset)</li>
<li>カメラ設定で D3DXMatrixLookAtLH を使って注視点を任意で動的に設定する場合、X軸回転が90度を越えてもカメラの上下は逆にならない。(カメラの上方向ベクトルを D3DXVECTOR3(0.0f, 1.0f, 0.0f) で指定しているので当たり前だが)</li>
<li>頂点バッファ(CreateVertexBuffer)を使用しない場合 → DrawPrimitiveUP</li>
<li>2Dで使う場合 → D3DFVF_XYZRHW</li>
<li>半透明にするものは後から描画する。(先に描画したら半透明にならないので)</li>
<li>半透明でない物は手前から描画する。(町を描いた後にそれを覆う山を書く場合、町の描画が無駄になる為)(2Dの場合、Z値は0.0固定にして描画処理順でZ順を制御してもいい)</li>
<li>DirectX9.0から SetVertexShader が SetFVF に変更された</li>
<li>SetRenderStateとかSetTextureとか、設定変えたらちゃんと元に戻さないとダメ。</li>
<li>ポリゴン数が多くてFPSが下がる場合、クリッピング、矩形分割、見える範囲のみ描画する。メモリもフィールドを一定矩形で分割し、必要な分だけ読み込むとか。</li>
<li>描画する時、SetRenderStateがいろいろ切り替わると描画効率が下がる。なので同じRenderStateで描画できる物は一まとめで描画する。</li>
<li>頂点フォグとピクセルフォグがあるが、どうやら頂点フォグの方がよく使う？らしい</li>
<li>ビュー行列→単位行列にした場合、位置は(0,0,0)、方向はZ軸プラス方向だった。</li>
<li>アルファテストでZソートしなくてもいい</li>
<li>Zソートする場合、単純に中心座標だけで比較はできない(内包する場合とか)</li>
<li>テクスチャとか、D3DXCreateSphereで作成したモデルとか、Xファイル読み込みモデルとか、１つあればそれを使いまわして描画可能。(大きさの違いは描画時にスケーリング。また読み込み時に頂点バッファをロックして直接座標を×2とかして最初にスケーリングしておく事も可。但し通常は読み込んだデータをその後スケーリングする場合は少ない。)</li>
<li>背景描画には天球を使ったりする。</li>
<li>プレゼンテーションパラメータ指定でアンチエイリアスできる</li>
<li>座標でW値？</li>
<li>SetRenderState、これからSetしようとする場合、Getして現状と違うならSetする</li>
<li>D3DXBoxBoundProbe 関数</li>
<li>D3DCLIPSTATUS9 構造体</li>
<li>視錐台</li>
<li>D3DXIntersect 関数</li>
<li>pD3DDevice-&gt;SetRenderState(D3DRS_ZENABLE, D3DZB_TRUE); // Ｚ比較を有効</li>
<li>pD3DDevice-&gt;SetRenderState(D3DRS_CULLMODE, D3DCULL_CCW); // 左回りでカリング</li>
<li>pD3DDevice-&gt;SetRenderState(D3DRS_ALPHABLENDENABLE, FALSE); // アルファブレンドを無効</li>
<li>フレームスキップ時、当たり判定考慮</li>
<li>頂点データ配列 → DrawPrimitiveUP</li>
<li>頂点バッファ → SetStreamSource → SetFVF → DrawPrimitive</li>
<li>ビルボード： 常にカメラに対して正対する表現方法</li>
<li>ポイントスプライト： パーティクル(火花、雪といった粒子状の物)の描画に適した手法。1頂点で常にカメラに対して自動的に正対してくれる。2Dテクスチャを張っただけの板ポリゴンでも、常にカメラの方向を向いてくれるので、手動で向きの計算を行う必要がない。</li>
<li>座標系：モデル座標を以下の順で変換される(最終的にはスクリーン座標になる)
<ol>
<li>モデル座標系: モデルの中心が原点の座標系(論理座標)</li>
<li>ワールド座標系: シーンの座標系。原点にあまり意味はない。(論理座標)</li>
<li>ビュー座標系: カメラ視点(カメラの位置と方向)にあわせて再定義した座標系。原点はカメラ。(論理座標)</li>
<li>射影座標系: 視点からの距離を基準にスケーリングした座標系。(論理座標)。カメラから見える全てのものを含んだ空間を「視錐台」という。</li>
<li>スクリーン座標系: 画面の座標系。(物理座標)。</li>
</ol>
</li>
<li>行列の合成: 座標変換は原点を基準に処理されるため、拡大縮小→回転→移動、の順番を守って合成しないとだめ。回転はX軸、Y軸、Z軸のどの順で回転させるかによって結果が異なる。</li>
</ul>

    </div>
</article>
            </main>
        </div>
    </div>

    <!-- サイトフッター -->
    <footer id="sdi-footer">
        <div id="sdi-footer-inner">
            
            <!-- プロフィール -->
            <div style="font-size: 115%; line-height: 1.1;">
                <div style="display: flex;">
                    <div style="flex-shrink: 0;">
                        <img src="/images/favicon-128.png" style="margin-right: 20px; border: 2px solid #e4e4e4; border-radius: 50%;" />
                    </div>
                    <div style="padding-top: 5px;">
                        <div style="display: flex; align-items: flex-end; flex-wrap: wrap; column-gap: 8px;">
                            <div style="font-size: 110%;">Yoshiheight</div>
                            <div>/</div>
                            <div style="font-size: 90%;">Programmer</div>
                        </div>
                        <div style="margin: 0.5em 0;">C#とTypeScriptに関することをメインに書いています。</div>
                        <div style="margin-top: 25px; text-decoration: underline;">
                            <a href="https://github.com/yoshiheight">GitHub</a>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; font-size: 98%;">
                Generated by <a style="text-decoration: underline;" href="https://github.com/yoshiheight/Sitegen">Sitegen</a>
            </div>
        </div>
    </footer>
</body>
</html>
