<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    
            <meta name="robots" content="noindex" />
        
    
            <meta name="robots" content="nofollow" />
        
    <meta name="description" content="C#とTypeScriptに関することをメインに書いています。" />

    <title>
        
                    [C++] 参照カウント式スマートポインタを自作 | Programmer&#39;s Note
                
    </title>

    
            <link rel="stylesheet" href="/sitegen-2.1.0/css/sitegen.css" />
        
            <link rel="stylesheet" href="/sitegen-2.1.0/css/sitegen-article.css" />
        

    <script type="module" src="/sitegen-2.1.0/js/initialize.js"></script>

    
    <link rel="icon" type="image/png" href="/images/favicon-32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/images/favicon-48.png" sizes="48x48" />
    <link rel="icon" type="image/png" href="/images/favicon-64.png" sizes="64x64" />
    <link rel="icon" type="image/png" href="/images/favicon-128.png" sizes="128x128" />
    <link rel="icon" type="image/png" href="/images/favicon-256.png" sizes="256x256" />
    <link rel="apple-touch-icon" href="/images/favicon-256.png" sizes="256x256" />
    <link rel="stylesheet" href="/css/custom-1.0.css" />
</head>
<body>
    <!-- サイトヘッダー -->
    <header id="sdi-header">
        <div id="sdi-header-inner">
            <div id="sdi-site-name"><a href="/">Programmer&#39;s Note</a></div>
            <div id="sdi-menu">
                <div class="sdc-menu-section">
                    
                                            <div>
                                                <a href="/categories/demo/">Demo</a>
                                            </div>
                                        
                                            <div>
                                                <a href="/categories/tech/">Tech</a>
                                            </div>
                                        
                                            <div>
                                                <a href="/categories/scrap/">Scrap</a>
                                            </div>
                                        
                </div>
                <div class="sdc-menu-section">
                    <div>
                        <a href="/tags/">Tags</a>
                    </div>
                    <div>
                        <a href="/search/">Search</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <div id="sdi-container">
        <div id="sdi-container-inner">
            <main>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.6.0/build/styles/base16/nova.min.css" />
<script type="module">
    import hljs from "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.6.0/build/es/highlight.min.js";
    hljs.highlightAll();
</script>
<script type="module">
    import mermaid from "https://unpkg.com/mermaid@9.1.3/dist/mermaid.esm.min.mjs";
    mermaid.initialize({ startOnLoad: true, theme: "base" });
</script>

<article id="sdi-entry-article">
    <!-- 記事ヘッダー -->
    <header>
        <!-- 記事タイトル -->
        <h1>[C++] 参照カウント式スマートポインタを自作</h1>

        <div id="sdi-article-header-annotation">
            <!-- タグ -->
            <div class="sdc-tags">
                <div class="sdc-tag sdc-primary-tag sdc-primary-tag2">
                    <a href="/categories/scrap/">Scrap</a>
                </div>
                
                                    <div class="sdc-tag">
                                        <a href="/tags/cpp/">C++</a>
                                    </div>
                                
            </div>

            <!-- 日付 -->
            <time datetime="2018-12-05">2018-12-05</time>
        </div>
    </header>

    <!-- 記事内容 -->
    <div id="sdi-article-body">
<h3>はじめに</h3>
<p>かなり前に久しぶりに<code>C++</code>で仕事をする機会があり、リハビリ用になにか適当に作ろうと思い、なんとなく書いた「参照カウント式スマートポインタ」です。</p>
<p><code>boost::shared_ptr</code>の簡易版みたいなものです。</p>
<h3>実装</h3>
<pre><code class="language-cpp">template&lt;class T&gt;
class SharedPtr
{
    // Constructors
public:
    SharedPtr();
    SharedPtr(const SharedPtr&lt;T&gt;&amp; src);
    explicit SharedPtr(T* ptr);
    ~SharedPtr();
    static SharedPtr&lt;T&gt; Create(T* ptr) { return SharedPtr&lt;T&gt;(ptr); }

    // Operations
public:
    // アロー演算子
    T* operator -&gt;() const { return m_ptr; }
    // 変換演算子
    operator T*() const { return m_ptr; }
    // 参照演算子
    T&amp; operator *() const { return *m_ptr; }
    // 代入演算子
    SharedPtr&lt;T&gt;&amp; operator =(const SharedPtr&lt;T&gt;&amp; src);

    // Member Function
public:
    T* Get() const { return m_ptr; }
    int __UseCount() const { return (m_ptr == NULL) ? 0 : (*m_pCount); }

private:
    void CopyImpl(const SharedPtr&lt;T&gt;&amp; src);
    void DeleteCheck();

    // Data Member
private:
    T* m_ptr;
    int* m_pCount;
};

template&lt;class T&gt;
SharedPtr&lt;T&gt;::SharedPtr()
    : m_ptr(NULL), m_pCount(NULL)
{
    std::cout &lt;&lt; &quot;SharedPtr&lt;T&gt;::SharedPtr()&quot; &lt;&lt; std::endl;
}

template&lt;class T&gt;
SharedPtr&lt;T&gt;::SharedPtr(const SharedPtr&lt;T&gt;&amp; src)
    : m_ptr(NULL), m_pCount(NULL)
{
    CopyImpl(src);

    std::cout &lt;&lt; &quot;SharedPtr&lt;T&gt;::SharedPtr(const SharedPtr&amp; src)&quot;
        &lt;&lt; std::endl;
}

template&lt;class T&gt;
SharedPtr&lt;T&gt;::SharedPtr(T* ptr)
    : m_ptr(NULL), m_pCount(NULL)
{
    m_ptr = ptr;
    m_pCount = new int(1);

    std::cout &lt;&lt; &quot;SharedPtr&lt;T&gt;::SharedPtr(T* ptr)&quot; &lt;&lt; std::endl;
}

template&lt;class T&gt;
SharedPtr&lt;T&gt;::~SharedPtr()
{
    std::cout &lt;&lt; &quot;SharedPtr&lt;T&gt;::~SharedPtr()&quot; &lt;&lt; std::endl;

    DeleteCheck();
}

template&lt;class T&gt;
SharedPtr&lt;T&gt;&amp; SharedPtr&lt;T&gt;::operator =(const SharedPtr&amp; src)
{
    CopyImpl(src);
    return *this;
}

template&lt;class T&gt;
void SharedPtr&lt;T&gt;::CopyImpl(const SharedPtr&lt;T&gt;&amp; src)
{
    if (this != &amp;src)
    {
        if (m_ptr != src.m_ptr)
        {
            DeleteCheck();

            if (src.m_ptr != NULL)
            {
                m_ptr = src.m_ptr;
                m_pCount = src.m_pCount;
                (*m_pCount)++;
            }
        }
    }
}

template&lt;class T&gt;
void SharedPtr&lt;T&gt;::DeleteCheck()
{
    if (m_ptr != NULL)
    {
        (*m_pCount)--;
        if ((*m_pCount) == 0)
        {
            delete m_ptr;
            m_ptr = NULL;
            delete m_pCount;
            m_pCount = NULL;
        }
    }
}
</code></pre>
<h3>テストコード</h3>
<pre><code class="language-cpp">class ShareTest
{
public:
    ShareTest() : num(-1) {}
    ~ShareTest() {}

    int num;
};

int main(int argc, char* argv[])
{
    // スコープを作っておいて最後に _CrtDumpMemoryLeaksを呼び出す
    {
        SharedPtr&lt;ShareTest&gt; spTest1(new ShareTest());
        {
            SharedPtr&lt;ShareTest&gt; spTest2(spTest1);
            SharedPtr&lt;ShareTest&gt; spTest3;
            SharedPtr&lt;ShareTest&gt; spTest4;

            ((ShareTest*) spTest1)-&gt;num = 5;

            spTest3 = spTest1;

            std::cout &lt;&lt; &quot;spTest1-&gt;num = &quot; &lt;&lt; spTest1-&gt;num &lt;&lt; std::endl;
            std::cout &lt;&lt; &quot;spTest2-&gt;num = &quot; &lt;&lt; spTest2-&gt;num &lt;&lt; std::endl;
            std::cout &lt;&lt; &quot;spTest3-&gt;num = &quot; &lt;&lt; spTest3-&gt;num &lt;&lt; std::endl;

            std::cout &lt;&lt; &quot;spTest4.use_count() = &quot; &lt;&lt; spTest4.__UseCount()
                &lt;&lt; std::endl;
            std::cout &lt;&lt; &quot;spTest3.use_count() = &quot; &lt;&lt; spTest3.__UseCount()
                &lt;&lt; std::endl;
            std::cout &lt;&lt; &quot;spTest2.use_count() = &quot; &lt;&lt; spTest2.__UseCount()
                &lt;&lt; std::endl;

            if (spTest4 == NULL) {
                std::cout &lt;&lt; &quot; NULL &quot; &lt;&lt; std::endl;
            }
        }
        std::cout &lt;&lt; &quot;spTest1.use_count() = &quot; &lt;&lt; spTest1.__UseCount()
            &lt;&lt; std::endl;
    }
    _CrtDumpMemoryLeaks();

    return 0;
}
</code></pre>
<h3>実行結果</h3>
<pre><code class="language-plaintext">SharedPtr&lt;T&gt;::SharedPtr(T* ptr)
SharedPtr&lt;T&gt;::SharedPtr(const SharedPtr&amp; src)
SharedPtr&lt;T&gt;::SharedPtr()
SharedPtr&lt;T&gt;::SharedPtr()
spTest1-&gt;num = 5
spTest2-&gt;num = 5
spTest3-&gt;num = 5
spTest4.use_count() = 0
spTest3.use_count() = 3
spTest2.use_count() = 3
 NULL
SharedPtr&lt;T&gt;::~SharedPtr()
SharedPtr&lt;T&gt;::~SharedPtr()
SharedPtr&lt;T&gt;::~SharedPtr()
spTest1.use_count() = 1
SharedPtr&lt;T&gt;::~SharedPtr()
</code></pre>
<p>とりあえず、ちゃんと機能しているようです。</p>

    </div>
</article>
            </main>
        </div>
    </div>

    <!-- サイトフッター -->
    <footer id="sdi-footer">
        <div id="sdi-footer-inner">
            
            <!-- プロフィール -->
            <div style="font-size: 115%; line-height: 1.1;">
                <div style="display: flex;">
                    <div style="flex-shrink: 0;">
                        <img src="/images/favicon-128.png" style="margin-right: 20px; border: 2px solid #e4e4e4; border-radius: 50%;" />
                    </div>
                    <div style="padding-top: 5px;">
                        <div style="display: flex; align-items: flex-end; flex-wrap: wrap; column-gap: 8px;">
                            <div style="font-size: 110%;">Yoshiheight</div>
                            <div>/</div>
                            <div style="font-size: 90%;">Programmer</div>
                        </div>
                        <div style="margin: 0.5em 0;">C#とTypeScriptに関することをメインに書いています。</div>
                        <div style="margin-top: 25px; text-decoration: underline;">
                            <a href="https://github.com/yoshiheight">GitHub</a>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; font-size: 98%;">
                Generated by <a style="text-decoration: underline;" href="https://github.com/yoshiheight/Sitegen">Sitegen</a>
            </div>
        </div>
    </footer>
</body>
</html>
