<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    
            <meta name="robots" content="noindex" />
        
    
            <meta name="robots" content="nofollow" />
        
    <meta name="description" content="C#とTypeScriptに関することをメインに書いています。" />

    <title>
        
                    [C#] IDisposableをインターフェイスのデフォルト実装で処理してみた | Programmer&#39;s Note
                
    </title>

    
            <link rel="stylesheet" href="/sitegen-2.1.0/css/sitegen.css" />
        
            <link rel="stylesheet" href="/sitegen-2.1.0/css/sitegen-article.css" />
        

    <script type="module" src="/sitegen-2.1.0/js/initialize.js"></script>

    
    <link rel="icon" type="image/png" href="/images/favicon-32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/images/favicon-48.png" sizes="48x48" />
    <link rel="icon" type="image/png" href="/images/favicon-64.png" sizes="64x64" />
    <link rel="icon" type="image/png" href="/images/favicon-128.png" sizes="128x128" />
    <link rel="icon" type="image/png" href="/images/favicon-256.png" sizes="256x256" />
    <link rel="apple-touch-icon" href="/images/favicon-256.png" sizes="256x256" />
    <link rel="stylesheet" href="/css/custom-1.0.css" />
</head>
<body>
    <!-- サイトヘッダー -->
    <header id="sdi-header">
        <div id="sdi-header-inner">
            <div id="sdi-site-name"><a href="/">Programmer&#39;s Note</a></div>
            <div id="sdi-menu">
                <div class="sdc-menu-section">
                    
                                            <div>
                                                <a href="/categories/demo/">Demo</a>
                                            </div>
                                        
                                            <div>
                                                <a href="/categories/tech/">Tech</a>
                                            </div>
                                        
                                            <div>
                                                <a href="/categories/scrap/">Scrap</a>
                                            </div>
                                        
                                            <div>
                                                <a href="/categories/tests/">Test&#39;s</a>
                                            </div>
                                        
                </div>
                <div class="sdc-menu-section">
                    <div>
                        <a href="/tags/">Tags</a>
                    </div>
                    <div>
                        <a href="/search/">Search</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <div id="sdi-container">
        <div id="sdi-container-inner">
            <main>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.6.0/build/styles/base16/nova.min.css" />
<script type="module">
    import hljs from "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.6.0/build/es/highlight.min.js";
    hljs.highlightAll();
</script>
<script type="module">
    import mermaid from "https://unpkg.com/mermaid@9.1.3/dist/mermaid.esm.min.mjs";
    mermaid.initialize({ startOnLoad: true, theme: "base" });
</script>

<article id="sdi-entry-article">
    <!-- 記事ヘッダー -->
    <header>
        <!-- 記事タイトル -->
        <h1>[C#] IDisposableをインターフェイスのデフォルト実装で処理してみた</h1>

        <div id="sdi-article-header-annotation">
            <!-- タグ -->
            <div class="sdc-tags">
                <div class="sdc-tag sdc-primary-tag sdc-primary-tag2">
                    <a href="/categories/scrap/">Scrap</a>
                </div>
                
                                    <div class="sdc-tag">
                                        <a href="/tags/cs/">C#</a>
                                    </div>
                                
            </div>

            <!-- 日付 -->
            <time datetime="2019-10-06">2019-10-06</time>
        </div>
    </header>

    <!-- 記事内容 -->
    <div id="sdi-article-body">
<h3>はじめに</h3>
<p>C# 8.0 でインターフェイスのデフォルト実装が可能になりました。</p>
<p>真っ先に思いついたのが IDisposable の実装で、うまくいったので記載します。</p>
<h3>ソースコード</h3>
<pre><code class="language-cs">using System;
using System.Collections.Concurrent;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Threading;

#nullable enable

class Program
{
    static void Main()
    {
        using var sample = new SampleClass();
    }
}

/// &lt;summary&gt;
/// サンプルクラス。
/// &lt;/summary&gt;
class SampleClass : IFieldAutoDisposable
{
    public DisposeContext DisposeContext { get; } = new DisposeContext();

    [DisposableField]
    private readonly MemoryStream _stream1 = new MemoryStream();

    [field: DisposableField]
    public MemoryStream Stream2 { get; } = new MemoryStream();
}

/// &lt;summary&gt;
/// フィールドを自動破棄するデフォルト実装を持つインターフェイス。
/// &lt;/summary&gt;
public interface IFieldAutoDisposable : IDisposable
{
    /// &lt;summary&gt;破棄対象のメタデータのキャッシュ。&lt;/summary&gt;
    private static readonly ConcurrentDictionary&lt;Type, Lazy&lt;TargetInfo[]&gt;&gt; _targetInfosTable =
        new ConcurrentDictionary&lt;Type, Lazy&lt;TargetInfo[]&gt;&gt;();

    /// &lt;summary&gt;破棄コンテキスト。&lt;/summary&gt;
    DisposeContext DisposeContext { get; }

    /// &lt;summary&gt;
    /// 破棄処理。
    /// &lt;/summary&gt;
    void IDisposable.Dispose()
    {
        if (Interlocked.CompareExchange(ref DisposeContext._disposedObject, this, null) == null)
        {
            DisposeFields(this);
        }
    }

    /// &lt;summary&gt;
    /// フィールドの自動破棄処理。
    /// &lt;/summary&gt;
    private static void DisposeFields(object obj)
    {
        foreach (var targetInfo in GetTargetInfos(obj.GetType()))
        {
            var targetObj = targetInfo.FieldInfo.GetValue(obj);
            if (targetObj is IDisposable disposableObj)
            {
                disposableObj.Dispose();
            }
        }

        // 破棄対象のメタデータの取得、キャッシュ
        static TargetInfo[] GetTargetInfos(Type type)
        {
            return _targetInfosTable.GetOrAdd(type, key =&gt; new Lazy&lt;TargetInfo[]&gt;(() =&gt; CreateTargetInfos(key))).Value;

            static TargetInfo[] CreateTargetInfos(Type type)
            {
                return type
                    .GetFields(BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance | BindingFlags.DeclaredOnly)
                    .Select(fi =&gt; (fi, attr: fi.GetCustomAttribute&lt;DisposableFieldAttribute&gt;()))
                    .Where(tuple =&gt; tuple.attr != null)
                    .Select(tuple =&gt; new TargetInfo(tuple.fi, tuple.attr!))
                    .ToArray();
            }
        }
    }

    /// &lt;summary&gt;
    /// 破棄対象のメタデータ。
    /// &lt;/summary&gt;
    private sealed class TargetInfo
    {
        public FieldInfo FieldInfo { get; }

        public DisposableFieldAttribute FieldAttr { get; }

        public TargetInfo(FieldInfo fieldInfo, DisposableFieldAttribute fieldAttr)
        {
            FieldInfo = fieldInfo;
            FieldAttr = fieldAttr;
        }
    }
}

/// &lt;summary&gt;
/// 破棄コンテキスト。
/// &lt;/summary&gt;
public sealed class DisposeContext
{
    internal volatile object? _disposedObject;

    public bool IsDisposed =&gt; _disposedObject != null;
}

/// &lt;summary&gt;
/// 自動破棄するフィールドに指定する属性。
/// &lt;/summary&gt;
[AttributeUsage(AttributeTargets.Field)]
public sealed class DisposableFieldAttribute : Attribute { }
</code></pre>
<h3>おわりに</h3>
<p>今回は対象の継承階層は考慮してませんが、本来は必要です。
あと、DisposableFieldAttribute に破棄する順序やグループも指定できるようにすると、より実用的だと思います。</p>

    </div>
</article>
            </main>
        </div>
    </div>

    <!-- サイトフッター -->
    <footer id="sdi-footer">
        <div id="sdi-footer-inner">
            
            <!-- プロフィール -->
            <div style="font-size: 115%; line-height: 1.1;">
                <div style="display: flex;">
                    <div style="flex-shrink: 0;">
                        <img src="/images/favicon-128.png" style="margin-right: 20px; border: 2px solid #e4e4e4; border-radius: 50%;" />
                    </div>
                    <div style="padding-top: 5px;">
                        <div style="display: flex; align-items: flex-end; flex-wrap: wrap; column-gap: 8px;">
                            <div style="font-size: 110%;">Yoshiheight</div>
                            <div>/</div>
                            <div style="font-size: 90%;">Programmer</div>
                        </div>
                        <div style="margin: 0.5em 0;">C#とTypeScriptに関することをメインに書いています。</div>
                        <div style="margin-top: 25px; text-decoration: underline;">
                            <a href="https://github.com/yoshiheight">GitHub</a>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; font-size: 98%;">
                Generated by <a style="text-decoration: underline;" href="https://github.com/yoshiheight/Sitegen">Sitegen</a>
            </div>
        </div>
    </footer>
</body>
</html>
