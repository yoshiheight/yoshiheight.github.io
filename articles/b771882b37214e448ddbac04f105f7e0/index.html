<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    
            <meta name="robots" content="noindex" />
        
    
            <meta name="robots" content="nofollow" />
        
    <meta name="description" content="C#とTypeScriptに関することをメインに書いています。" />

    <title>
        
                    [C#] 透過プロキシでREST Clientを実装してQiita APIをたたいてみる | Programmer&#39;s Note
                
    </title>

    
            <link rel="stylesheet" href="/sitegen-2.1.0/css/sitegen.css" />
        
            <link rel="stylesheet" href="/sitegen-2.1.0/css/sitegen-article.css" />
        

    <script type="module" src="/sitegen-2.1.0/js/initialize.js"></script>

    
    <link rel="icon" type="image/png" href="/images/favicon-32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/images/favicon-48.png" sizes="48x48" />
    <link rel="icon" type="image/png" href="/images/favicon-64.png" sizes="64x64" />
    <link rel="icon" type="image/png" href="/images/favicon-128.png" sizes="128x128" />
    <link rel="icon" type="image/png" href="/images/favicon-256.png" sizes="256x256" />
    <link rel="apple-touch-icon" href="/images/favicon-256.png" sizes="256x256" />
    <link rel="stylesheet" href="/css/custom-1.0.css" />
</head>
<body>
    <!-- サイトヘッダー -->
    <header id="sdi-header">
        <div id="sdi-header-inner">
            <div id="sdi-site-name"><a href="/">Programmer&#39;s Note</a></div>
            <div id="sdi-menu">
                <div class="sdc-menu-section">
                    
                                            <div>
                                                <a href="/categories/demo/">Demo</a>
                                            </div>
                                        
                                            <div>
                                                <a href="/categories/tech/">Tech</a>
                                            </div>
                                        
                                            <div>
                                                <a href="/categories/scrap/">Scrap</a>
                                            </div>
                                        
                </div>
                <div class="sdc-menu-section">
                    <div>
                        <a href="/tags/">Tags</a>
                    </div>
                    <div>
                        <a href="/search/">Search</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <div id="sdi-container">
        <div id="sdi-container-inner">
            <main>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.6.0/build/styles/base16/nova.min.css" />
<script type="module">
    import hljs from "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.6.0/build/es/highlight.min.js";
    hljs.highlightAll();
</script>
<script type="module">
    import mermaid from "https://unpkg.com/mermaid@9.1.3/dist/mermaid.esm.min.mjs";
    mermaid.initialize({ startOnLoad: true, theme: "base" });
</script>

<article id="sdi-entry-article">
    <!-- 記事ヘッダー -->
    <header>
        <!-- 記事タイトル -->
        <h1>[C#] 透過プロキシでREST Clientを実装してQiita APIをたたいてみる</h1>

        <div id="sdi-article-header-annotation">
            <!-- タグ -->
            <div class="sdc-tags">
                <div class="sdc-tag sdc-primary-tag sdc-primary-tag2">
                    <a href="/categories/scrap/">Scrap</a>
                </div>
                
                                    <div class="sdc-tag">
                                        <a href="/tags/cs/">C#</a>
                                    </div>
                                
                                    <div class="sdc-tag">
                                        <a href="/tags/rest/">REST</a>
                                    </div>
                                
                                    <div class="sdc-tag">
                                        <a href="/tags/aop/">AOP</a>
                                    </div>
                                
            </div>

            <!-- 日付 -->
            <time datetime="2018-11-26">2018-11-26</time>
        </div>
    </header>

    <!-- 記事内容 -->
    <div id="sdi-article-body">
<h3>はじめに</h3>
<p>RestSharpを試してみようと思い、Qiita APIでタグ一覧を取得してみました。</p>
<p><a href="https://qiita.com/api/v2/docs">https://qiita.com/api/v2/docs</a></p>
<p>普通にRestSharpを使うのでは面白くないので、
以下のようにインターフェイスを用意すれば簡単にREST Clientが作れる仕組みを実装してみます。</p>
<pre><code class="language-cs">// こんな風にRESTクライアントを定義
public interface IQiitaApi
{
    [RestApi(Path = &quot;/api/v2/tags&quot;, Method = RequestMethod.Get)]
    QiitaTagInfo[] GetTags(
        [RestParam(&quot;page&quot;)] int page,
        [RestParam(&quot;per_page&quot;)] int perPage,
        [RestParam(&quot;sort&quot;)] QiitaTagSortMode sortMode);
}

[DataContract]
public enum QiitaTagSortMode
{
    [EnumMember(Value = &quot;count&quot;)]
    Count,

    [EnumMember(Value = &quot;name&quot;)]
    Name,
}

// 関係ないけど、あえて [JsonObject(MemberSerialization.OptIn)] を試す
[JsonObject(MemberSerialization.OptIn)]
public sealed class QiitaTagInfo
{
    [JsonProperty(&quot;id&quot;)]
    public string Id { get; set; }

    [JsonProperty(&quot;items_count&quot;)]
    public int Count { get; set; }

    [JsonProperty(&quot;followers_count&quot;)]
    public int FollowersCount { get; set; }
}
</code></pre>
<pre><code class="language-cs">// こんな風に使う
var factory = new RestApiFactory(&quot;https://qiita.com&quot;);
var api = factory.Create&lt;IQiitaApi&gt;();
var result = api.GetTags(1, 20, QiitaTagSortMode.Count);
</code></pre>
<h3>実装</h3>
<ul>
<li>使用ライブラリ
<ul>
<li>RestSharp
<ul>
<li><a href="https://www.nuget.org/packages/RestSharp/">https://www.nuget.org/packages/RestSharp/</a></li>
</ul>
</li>
<li>Json.NET
<ul>
<li><a href="https://www.nuget.org/packages/Newtonsoft.Json/">https://www.nuget.org/packages/Newtonsoft.Json/</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>C#でAOP（アスペクト指向的）なことを実現するには<code>RealProxy</code>クラスを使用します。</p>
<pre><code class="language-cs">public sealed class RestApiFactory
{
    private readonly string _baseUrl;

    public RestApiFactory(string baseUrl)
    {
        _baseUrl = baseUrl;
    }

    public TApi Create&lt;TApi&gt;()
    {
        var proxy = new RestApiProxy&lt;TApi&gt;(_baseUrl);
        return (TApi)proxy.GetTransparentProxy();
    }
}

public sealed class RestApiProxy&lt;TApi&gt; : RealProxy
{
    private readonly RestClient _client;

    public RestApiProxy(string baseUrl)
        : base(typeof(TApi))
    {
        _client = new RestClient(baseUrl);
    }

    public override IMessage Invoke(IMessage message)
    {
        var methodMessage = (IMethodCallMessage)message;
        var methodInfo = (MethodInfo)methodMessage.MethodBase;

        var apiAttr = methodInfo.GetCustomAttribute&lt;RestApiAttribute&gt;();
        var request = new RestRequest(apiAttr.Path, (Method)Enum.Parse(typeof(Method), apiAttr.Method.ToString(), true));

        var serializer = new JsonSerializer();
        serializer.Converters.Add(new StringEnumConverter());
        var args = JArray.FromObject(methodMessage.Args, serializer);

        var paramInfos = methodMessage.MethodBase.GetParameters();
        foreach (var item in args.Zip(paramInfos, (arg, paramInfo) =&gt; new { arg, paramInfo }))
        {
            var paramAttr = item.paramInfo.GetCustomAttribute&lt;RestParamAttribute&gt;();
            request.AddParameter(paramAttr.Name, item.arg);
        }

        var response = _client.Execute(request);
        if (response.ResponseStatus != ResponseStatus.Completed)
        {
            throw new RestException(response.StatusCode, response.ErrorMessage, response.ErrorException);
        }

        var result = JsonConvert.DeserializeObject(response.Content, methodInfo.ReturnType);
        return new ReturnMessage(result, null, 0, methodMessage.LogicalCallContext, methodMessage);
    }
}

public enum RequestMethod
{
    Get,
    Post,
}

public sealed class RestApiAttribute : Attribute
{
    public string Path { get; set; }
    public RequestMethod Method { get; set; }
}

public sealed class RestParamAttribute : Attribute
{
    public string Name { get; }

    public RestParamAttribute(string name)
    {
        Name = name;
    }
}

public sealed class RestException : Exception
{
    public HttpStatusCode StatusCode { get; }

    public RestException(HttpStatusCode statusCode, string errorMessage, Exception errorException)
        : base(errorMessage, errorException)
    {
        StatusCode = statusCode;
    }
}
</code></pre>
<h3>動かしてみる</h3>
<pre><code class="language-cs">// SSL関連で必要であれば呼ぶ
// ServicePointManager.ServerCertificateValidationCallback = (sender, certificate, chain, sslPolicyErrors) =&gt; true;
// ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls | SecurityProtocolType.Tls11 | SecurityProtocolType.Tls12;

var factory = new RestApiFactory(&quot;https://qiita.com&quot;);
var api = factory.Create&lt;IQiitaApi&gt;();
var result = api.GetTags(1, 20, QiitaTagSortMode.Count);

foreach (var tagInfo in result)
{
    Console.Write(tagInfo.Id.PadRight(15));
    Console.Write(tagInfo.Count.ToString().PadRight(10));
    Console.WriteLine(tagInfo.FollowersCount);
}
</code></pre>
<pre><code class="language-plaintext">[実行結果]
JavaScript     21990     48870
Python         21863     41067
Ruby           18711     27500
PHP            13818     30173
Rails          12594     16450
iOS            12455     23069
Android        10915     29762
AWS            10528     5003
Java           10359     31906
Swift          10273     6167
Linux          8773      28311
docker         8226      4966
Git            7125      27652
Node.js        7021      20220
Mac            6631      22047
Unity          5970      3849
C#             5970      17342
MySQL          5301      22457
C++            5065      19147
Xcode          4844      16773
</code></pre>
<p>JavaScriptの記事が一番多いですね。</p>

    </div>
</article>
            </main>
        </div>
    </div>

    <!-- サイトフッター -->
    <footer id="sdi-footer">
        <div id="sdi-footer-inner">
            
            <!-- プロフィール -->
            <div style="font-size: 115%; line-height: 1.1;">
                <div style="display: flex;">
                    <div style="flex-shrink: 0;">
                        <img src="/images/favicon-128.png" style="margin-right: 20px; border: 2px solid #e4e4e4; border-radius: 50%;" />
                    </div>
                    <div style="padding-top: 5px;">
                        <div style="display: flex; align-items: flex-end; flex-wrap: wrap; column-gap: 8px;">
                            <div style="font-size: 110%;">Yoshiheight</div>
                            <div>/</div>
                            <div style="font-size: 90%;">Programmer</div>
                        </div>
                        <div style="margin: 0.5em 0;">C#とTypeScriptに関することをメインに書いています。</div>
                        <div style="margin-top: 25px; text-decoration: underline;">
                            <a href="https://github.com/yoshiheight">GitHub</a>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; font-size: 98%;">
                Generated by <a style="text-decoration: underline;" href="https://github.com/yoshiheight/Sitegen">Sitegen</a>
            </div>
        </div>
    </footer>
</body>
</html>
