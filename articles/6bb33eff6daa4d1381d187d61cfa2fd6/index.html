<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    
            <meta name="robots" content="noindex" />
        
    
            <meta name="robots" content="nofollow" />
        
    <meta name="description" content="C#とTypeScriptに関することをメインに書いています。" />

    <title>
        
                    [C#] DispatchProxyでREST Clientを実装して非同期でQiita APIをたたいてみる | Programmer&#39;s Note
                
    </title>

    
            <link rel="stylesheet" href="/sitegen-2.1.0/css/sitegen.css" />
        
            <link rel="stylesheet" href="/sitegen-2.1.0/css/sitegen-article.css" />
        

    <script type="module" src="/sitegen-2.1.0/js/initialize.js"></script>

    
    <link rel="icon" type="image/png" href="/images/favicon-32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/images/favicon-48.png" sizes="48x48" />
    <link rel="icon" type="image/png" href="/images/favicon-64.png" sizes="64x64" />
    <link rel="icon" type="image/png" href="/images/favicon-128.png" sizes="128x128" />
    <link rel="icon" type="image/png" href="/images/favicon-256.png" sizes="256x256" />
    <link rel="apple-touch-icon" href="/images/favicon-256.png" sizes="256x256" />
    <link rel="stylesheet" href="/css/custom-1.0.css" />
</head>
<body>
    <!-- サイトヘッダー -->
    <header id="sdi-header">
        <div id="sdi-header-inner">
            <div id="sdi-site-name"><a href="/">Programmer&#39;s Note</a></div>
            <div id="sdi-menu">
                <div class="sdc-menu-section">
                    
                                            <div>
                                                <a href="/categories/demo/">Demo</a>
                                            </div>
                                        
                                            <div>
                                                <a href="/categories/tech/">Tech</a>
                                            </div>
                                        
                                            <div>
                                                <a href="/categories/scrap/">Scrap</a>
                                            </div>
                                        
                </div>
                <div class="sdc-menu-section">
                    <div>
                        <a href="/tags/">Tags</a>
                    </div>
                    <div>
                        <a href="/search/">Search</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <div id="sdi-container">
        <div id="sdi-container-inner">
            <main>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.6.0/build/styles/base16/nova.min.css" />
<script type="module">
    import hljs from "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.6.0/build/es/highlight.min.js";
    hljs.highlightAll();
</script>
<script type="module">
    import mermaid from "https://unpkg.com/mermaid@9.1.3/dist/mermaid.esm.min.mjs";
    mermaid.initialize({ startOnLoad: true, theme: "base" });
</script>

<article id="sdi-entry-article">
    <!-- 記事ヘッダー -->
    <header>
        <!-- 記事タイトル -->
        <h1>[C#] DispatchProxyでREST Clientを実装して非同期でQiita APIをたたいてみる</h1>

        <div id="sdi-article-header-annotation">
            <!-- タグ -->
            <div class="sdc-tags">
                <div class="sdc-tag sdc-primary-tag sdc-primary-tag2">
                    <a href="/categories/scrap/">Scrap</a>
                </div>
                
                                    <div class="sdc-tag">
                                        <a href="/tags/cs/">C#</a>
                                    </div>
                                
                                    <div class="sdc-tag">
                                        <a href="/tags/rest/">REST</a>
                                    </div>
                                
                                    <div class="sdc-tag">
                                        <a href="/tags/aop/">AOP</a>
                                    </div>
                                
            </div>

            <!-- 日付 -->
            <time datetime="2019-10-18">2019-10-18</time>
        </div>
    </header>

    <!-- 記事内容 -->
    <div id="sdi-article-body">
<h3>はじめに</h3>
<p>以前書いた以下の記事を .NET Core の DispatchProxy を使用するように変更し、更にRESTでの取得処理を非同期にしました。</p>
<ul>
<li>透過プロキシでREST Clientを実装してQiita APIをたたいてみる
<ul>
<li><a href="https://crash.jp/pages/b771882b37214e448ddbac04f105f7e0/">https://crash.jp/pages/b771882b37214e448ddbac04f105f7e0/</a></li>
</ul>
</li>
</ul>
<h3>ソースコード</h3>
<p>環境は .NET Core 3.0 / C# 8.0</p>
<pre><code class="language-cs">using System;
using System.Linq;
using System.Net;
using System.Reflection;
using System.Runtime.CompilerServices;
using System.Runtime.Serialization;
using System.Threading.Tasks;
using Newtonsoft.Json;
using Newtonsoft.Json.Converters;
using Newtonsoft.Json.Linq;
using RestSharp;

#nullable enable

class Program
{
    static async Task Main()
    {
        var client = RestClientProxy.Create&lt;IQiitaApiClient&gt;(&quot;https://qiita.com&quot;);
        foreach (var tagInfo in await client.GetTagsAsync(1, 20, QiitaTagSortMode.Count))
        {
            Console.Write(tagInfo.Id.PadRight(15));
            Console.Write(tagInfo.Count.ToString().PadRight(10));
            Console.WriteLine(tagInfo.FollowersCount);
        }
    }
}

// 以下、Qiita API クライアント

public interface IQiitaApiClient
{
    [RestApi(Path = &quot;/api/v2/tags&quot;, Method = RequestMethod.Get)]
    Task&lt;QiitaTagInfo[]&gt; GetTagsAsync(
        [RestParam(&quot;page&quot;)] int page,
        [RestParam(&quot;per_page&quot;)] int perPage,
        [RestParam(&quot;sort&quot;)] QiitaTagSortMode sortMode);
}

[DataContract]
public enum QiitaTagSortMode
{
    [EnumMember(Value = &quot;count&quot;)]
    Count,

    [EnumMember(Value = &quot;name&quot;)]
    Name,
}

[DataContract]
public sealed class QiitaTagInfo
{
    [DataMember(Name = &quot;id&quot;)]
    public string Id { get; set; } = string.Empty;

    [DataMember(Name = &quot;items_count&quot;)]
    public int Count { get; set; }

    [DataMember(Name = &quot;followers_count&quot;)]
    public int FollowersCount { get; set; }
}

// 以下、共通部品

// DispatchProxyから派生する場合、sealedにはできない。あとpublicなデフォルトコンストラクタが必要
public class RestClientProxy : DispatchProxy
{
    private RestClient _client = null!;

    public static TRestApiClient Create&lt;TRestApiClient&gt;(string baseUrl)
        where TRestApiClient : class
    {
        var proxy = Create&lt;TRestApiClient, RestClientProxy&gt;();
        ((RestClientProxy)(object)proxy).Init(baseUrl);
        return proxy;
    }

    private void Init(string baseUrl)
    {
        _client = new RestClient(baseUrl);
    }

    protected override object Invoke(MethodInfo methodInfo, object[] args)
    {
        var apiAttr = methodInfo.GetCustomAttribute&lt;RestApiAttribute&gt;()!;
        var request = new RestRequest(apiAttr.Path, Enum.Parse&lt;Method&gt;(apiAttr.Method.ToString(), true));

        var serializer = new JsonSerializer();
        serializer.Converters.Add(new StringEnumConverter());
        var jsonArgs = JArray.FromObject(args, serializer);

        var paramInfos = methodInfo.GetParameters();
        foreach (var item in jsonArgs.Zip(paramInfos, (arg, paramInfo) =&gt; (arg, paramInfo)))
        {
            var paramAttr = item.paramInfo.GetCustomAttribute&lt;RestParamAttribute&gt;()!;
            request.AddParameter(paramAttr.Name, item.arg);
        }

        var resultType = methodInfo.ReturnType.GenericTypeArguments[0];
        return ResultTypedTaskFactory.Create(
            DeserializeResultAsync(_client.ExecuteTaskAsync(request), resultType),
            resultType);

        // 戻り値のデシリアライズ
        static async Task&lt;object?&gt; DeserializeResultAsync(Task&lt;IRestResponse&gt; executeTask, Type resultType)
        {
            var response = await executeTask.ConfigureAwait(false);
            if (response.ResponseStatus != ResponseStatus.Completed)
            {
                throw new RestException(response.StatusCode, response.ErrorMessage, response.ErrorException);
            }
            return JsonConvert.DeserializeObject(response.Content, resultType);
        }
    }
}

public enum RequestMethod
{
    Get,
    Post,
}

[AttributeUsage(AttributeTargets.Method)]
public sealed class RestApiAttribute : Attribute
{
    public string Path { get; set; } = string.Empty;

    public RequestMethod Method { get; set; }
}

[AttributeUsage(AttributeTargets.Parameter)]
public sealed class RestParamAttribute : Attribute
{
    public string Name { get; }

    public RestParamAttribute(string name)
    {
        Name = name;
    }
}

public sealed class RestException : Exception
{
    public HttpStatusCode StatusCode { get; }

    public RestException(HttpStatusCode statusCode, string errorMessage, Exception errorException)
        : base(errorMessage, errorException)
    {
        StatusCode = statusCode;
    }
}

public static class ResultTypedTaskFactory
{
    public static object Create(Task&lt;object?&gt; task, Type resultType)
    {
        var genericType = typeof(TaskInvoker&lt;&gt;).MakeGenericType(resultType);
        var taskGetter = (ITaskGetter)Activator.CreateInstance(genericType, task).AsNotNullable();
        return taskGetter.ResultTypedTask;
    }

    private interface ITaskGetter
    {
        object ResultTypedTask { get; }
    }

    private sealed class TaskInvoker&lt;TResult&gt; : ITaskGetter
    {
        public object ResultTypedTask { get; }

        public TaskInvoker(Task&lt;object?&gt; task)
        {
            ResultTypedTask = InvokeAsync();

            async Task&lt;TResult&gt; InvokeAsync()
            {
                return (TResult)(await task.ConfigureAwait(false))!;
            }
        }
    }
}
</code></pre>
<h3>実行結果</h3>
<pre><code class="language-plaintext">Python         32273     62544
JavaScript     28966     65017
Ruby           23669     36895
Rails          19410     24176
PHP            17307     40479
AWS            14834     6928
iOS            14642     32042
Android        13140     39289
Java           13062     42886
Swift          12597     6856
Docker         11643     6509
Linux          10820     40215
Node.js        9787      29395
Git            8969      38904
Mac            8198      31382
Python3        8130      3156
Unity          8119      4759
C#             8035      25641
Go             7201      5068
MySQL          6721      32644
</code></pre>
<h3>おわりに</h3>
<p>以前はJavaScriptの記事が一番多かったですが、現在はPythonが多いですね。</p>

    </div>
</article>
            </main>
        </div>
    </div>

    <!-- サイトフッター -->
    <footer id="sdi-footer">
        <div id="sdi-footer-inner">
            
            <!-- プロフィール -->
            <div style="font-size: 115%; line-height: 1.1;">
                <div style="display: flex;">
                    <div style="flex-shrink: 0;">
                        <img src="/images/favicon-128.png" style="margin-right: 20px; border: 2px solid #e4e4e4; border-radius: 50%;" />
                    </div>
                    <div style="padding-top: 5px;">
                        <div style="display: flex; align-items: flex-end; flex-wrap: wrap; column-gap: 8px;">
                            <div style="font-size: 110%;">Yoshiheight</div>
                            <div>/</div>
                            <div style="font-size: 90%;">Programmer</div>
                        </div>
                        <div style="margin: 0.5em 0;">C#とTypeScriptに関することをメインに書いています。</div>
                        <div style="margin-top: 25px; text-decoration: underline;">
                            <a href="https://github.com/yoshiheight">GitHub</a>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; font-size: 98%;">
                Generated by <a style="text-decoration: underline;" href="https://github.com/yoshiheight/Sitegen">Sitegen</a>
            </div>
        </div>
    </footer>
</body>
</html>
